<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- [The rest of the HEAD section remains exactly the same as in the previous code] -->
    <style>
        /* [All CSS styles remain exactly the same as in the previous code] */
    </style>
</head>
<body>
    <div class="container">
        <!-- [The entire HTML structure remains the same up to the "Financial Summary" section] -->

        <!-- Totals Section - MODIFIED -->
        <div class="form-section totals-section">
            <h4><i class="fas fa-calculator"></i> Financial Summary</h4>
            <!-- New Tax Rate Input Row -->
            <div class="form-row">
                <div class="form-group">
                    <label for="taxRateInput">Tax Rate (%)</label>
                    <input type="number" id="taxRateInput" name="taxRateInput" value="0" min="0" max="100" step="0.01" style="width: 100px;">
                    <span style="margin-left: 10px; color: #666;">Enter 0 for no tax</span>
                </div>
            </div>
            <!-- Totals Display Rows -->
            <div class="total-row">
                <span>Subtotal:</span>
                <span id="subtotalDisplay">0 UGX</span>
            </div>
            <div class="total-row">
                <span>Tax Amount:</span>
                <span id="taxDisplay">0 UGX</span>
            </div>
            <div class="total-row grand-total">
                <span>GRAND TOTAL:</span>
                <span id="grandTotalDisplay">0 UGX</span>
            </div>
        </div>

        <!-- [The rest of the HTML remains exactly the same] -->
    </div>

    <!-- FONT AWESOME FOR ICONS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

    <!-- MAIN APPLICATION JAVASCRIPT -->
    <script>
        // ============================
        // APPLICATION STATE & SETUP
        // ============================
        let currentDocumentType = '';
        let currentDocumentData = null;
        let allDocuments = JSON.parse(localStorage.getItem('samani_documents')) || [];

        // Initialize the application when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            loadDocumentArchive();
        });

        // ============================
        // INITIALIZATION FUNCTIONS
        // ============================
        function initializeApp() {
            setupEventListeners();
            setupDefaultDates();
            addFirstItemRow();
        }

        function setupEventListeners() {
            // [All existing event listeners remain the same]

            // NEW: Add listener for tax rate input
            document.getElementById('taxRateInput').addEventListener('input', calculateDocumentTotals);
        }

        function setupDefaultDates() {
            // [This function remains the same]
        }

        // ============================
        // DOCUMENT CREATION & FORM HANDLING
        // ============================
        function createNewDocument(type) {
            // [This function remains the same until the end]
        }

        function generateReferenceNumber(type) {
            // [This function remains the same]
        }

        function cancelForm() {
            // [This function remains the same]
        }

        // ============================
        // ITEMS TABLE MANAGEMENT
        // ============================
        function addFirstItemRow() {
            // [This function remains the same]
        }

        function resetItemsTable() {
            // [This function remains the same]
        }

        function addNewItemRow() {
            // [This function remains the same]
        }

        function removeItemRow(button) {
            // [This function remains the same]
        }

        function calculateItemTotal(inputElement) {
            // [This function remains the same]
        }

        // MODIFIED FUNCTION: Now calculates tax based on user input
        function calculateDocumentTotals() {
            const rows = document.querySelectorAll('#itemsBody tr');
            let subtotal = 0;
            
            rows.forEach(row => {
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const rate = parseFloat(row.querySelector('.item-rate').value) || 0;
                subtotal += qty * rate;
            });
            
            // Get tax rate from user input (default is 0)
            const taxRateInput = document.getElementById('taxRateInput');
            const taxRate = parseFloat(taxRateInput.value) || 0;
            
            // Calculate tax amount and grand total
            const taxAmount = subtotal * (taxRate / 100);
            const grandTotal = subtotal + taxAmount;
            
            // Update display
            document.getElementById('subtotalDisplay').textContent = formatCurrency(subtotal);
            document.getElementById('taxDisplay').textContent = formatCurrency(taxAmount);
            document.getElementById('grandTotalDisplay').textContent = formatCurrency(grandTotal);
            
            return { 
                subtotal, 
                taxRate,  // Now includes the rate
                taxAmount, 
                grandTotal 
            };
        }

        // ============================
        // PREVIEW & PDF GENERATION
        // ============================
        function validateForm() {
            // [This function remains the same]
        }

        function collectFormData() {
            const formData = new FormData(document.getElementById('documentForm'));
            const data = Object.fromEntries(formData.entries());
            
            // Collect items
            const items = [];
            document.querySelectorAll('#itemsBody tr').forEach(row => {
                const name = row.querySelector('.item-name').value.trim();
                if (name) {
                    items.push({
                        name: name,
                        description: row.querySelector('.item-desc').value.trim(),
                        quantity: parseFloat(row.querySelector('.item-qty').value) || 1,
                        rate: parseFloat(row.querySelector('.item-rate').value) || 0,
                        total: parseFloat(row.querySelector('.item-total').value.replace(/[^0-9.-]+/g, '')) || 0
                    });
                }
            });
            
            // Get totals including tax rate
            const totals = calculateDocumentTotals();
            
            return {
                ...data,
                items: items,
                subtotal: totals.subtotal,
                taxRate: totals.taxRate,      // Store the tax rate
                taxAmount: totals.taxAmount,
                grandTotal: totals.grandTotal,
                createdAt: new Date().toISOString(),
                status: 'created'
            };
        }

        function previewDocument() {
            // [This function remains the same]
        }

        // MODIFIED: Updated to show conditional tax information
        function generatePreviewHTML(doc) {
            const type = doc.docType.toUpperCase();
            const stampUrl = 'https://i.ibb.co/8LFKMz6T/co-stamp-SAMANI.jpg';
            
            let previewHTML = `
                <div class="pdf-preview">
                    <!-- [Header and document info sections remain the same] -->
                    
                    <div class="pdf-totals">
                        <table class="pdf-totals-table">
                            <tr>
                                <td><strong>Subtotal:</strong></td>
                                <td>${formatCurrency(doc.subtotal)}</td>
                            </tr>`;
            
            // Conditionally show tax row only if tax rate > 0
            if (doc.taxRate > 0) {
                previewHTML += `
                            <tr>
                                <td><strong>Tax (${doc.taxRate}%):</strong></td>
                                <td>${formatCurrency(doc.taxAmount)}</td>
                            </tr>`;
            }
            
            previewHTML += `
                            <tr style="font-size: 18px; font-weight: bold;">
                                <td><strong>GRAND TOTAL:</strong></td>
                                <td>${formatCurrency(doc.grandTotal)}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- [Rest of the preview HTML remains the same] -->
                </div>`;
            
            document.getElementById('previewContent').innerHTML = previewHTML;
        }

        async function generatePdfFromForm() {
            // [This function remains the same]
        }

        // MODIFIED: Updated PDF generation to handle conditional tax
        async function generateAndDownloadPdf(doc) {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 20;
            let yPos = margin;
            
            // [Logo, header, and document info sections remain the same]
            
            yPos += 5;
            pdf.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 10;
            
            // Totals - UPDATED for conditional tax display
            pdf.text('Subtotal:', pageWidth - margin - 50, yPos);
            pdf.text(formatCurrency(doc.subtotal), pageWidth - margin, yPos, { align: 'right' });
            
            // Only show tax if rate > 0
            if (doc.taxRate > 0) {
                yPos += 7;
                pdf.text(`Tax (${doc.taxRate}%):`, pageWidth - margin - 50, yPos);
                pdf.text(formatCurrency(doc.taxAmount), pageWidth - margin, yPos, { align: 'right' });
            }
            
            yPos += 7;
            pdf.setFont('helvetica', 'bold');
            pdf.text('GRAND TOTAL:', pageWidth - margin - 50, yPos);
            pdf.text(formatCurrency(doc.grandTotal), pageWidth - margin, yPos, { align: 'right' });
            
            // [Rest of the PDF generation function remains the same]
        }

        function getImageData(url) {
            // [This function remains the same]
        }

        function downloadPdfFromPreview() {
            // [This function remains the same]
        }

        function printPreview() {
            // [This function remains the same]
        }

        function closeModal() {
            // [This function remains the same]
        }

        // ============================
        // DOCUMENT ARCHIVE MANAGEMENT
        // ============================
        function saveDocumentToArchive(doc) {
            // [This function remains the same]
        }

        function loadDocumentArchive() {
            // [This function remains the same]
        }

        function viewArchivedDocument(index) {
            // [This function remains the same]
        }

        function recreateDocument(index) {
            const doc = allDocuments[index];
            
            // Switch to create tab
            switchTab('create');
            
            // Set document type and trigger form
            createNewDocument(doc.docType);
            
            // Populate form fields
            setTimeout(() => {
                // [All existing field population remains the same]
                
                // NEW: Set the tax rate
                document.getElementById('taxRateInput').value = doc.taxRate || 0;
                
                // [Rest of the recreation logic remains the same]
            }, 100);
        }

        function deleteArchivedDocument(index) {
            // [This function remains the same]
        }

        // ============================
        // UTILITY FUNCTIONS
        // ============================
        function formatCurrency(amount) {
            // [This function remains the same]
        }

        function switchTab(tabName) {
            // [This function remains the same]
        }

        // Make functions available globally for onclick handlers
        window.removeItemRow = removeItemRow;
        window.viewArchivedDocument = viewArchivedDocument;
        window.recreateDocument = recreateDocument;
        window.deleteArchivedDocument = deleteArchivedDocument;
    </script>
</body>
</html>
